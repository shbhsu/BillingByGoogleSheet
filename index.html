<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head runat="server">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta charset="UTF-8">


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" crossorigin="anonymous">


    <script src="https://code.jquery.com/jquery-1.12.4.js" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="http://www.developerdan.com/table-to-json/javascripts/jquery.tabletojson.min.js" crossorigin="anonymous"></script>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.4/highcharts.js"></script>


    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>

    <link rel="stylesheet" href="//cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" crossorigin="anonymous">
    <script>

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        var googleURL = '';

        function makeHttpObject() {
            try {
                googleURL = getParameterByName("GoogleURL");
                return new XMLHttpRequest();

            }
            catch (error) { }
            try { return new ActiveXObject("Msxml2.XMLHTTP"); }
            catch (error) { }
            try { return new ActiveXObject("Microsoft.XMLHTTP"); }
            catch (error) { }

            throw new Error("Could not create HTTP request object.");
        }
        var request = makeHttpObject();
        request.open("GET", googleURL, true);
        request.send(null);

        var tableHTML = '';
        var table = '';
        var chartSeries = [];
        var total;

        request.onreadystatechange = function () {
            if (request.readyState == 4)

                tableHTML = (request.responseText).substring(request.responseText.indexOf("<table"), request.responseText.indexOf("</table")) + "</table>";
            var thead = tableHTML.substring(tableHTML.indexOf("<tr"), tableHTML.indexOf("</tr")) + "</tr>";
            tableHTML = tableHTML.replace(thead, "");
            tableHTML = tableHTML.replace(" cellspacing=\"0\">", " cellspacing='0'><thead>" + thead + "</thead>");


            $('#tableList').html(tableHTML.replace("<table", "<table id='TableResult' class='table table- striped' width='100%' "));




            var $table = $('#TableResult');

            table = $table.tableToJSON();
            var newTable = $.map(table, function (e) {
                return (e.FirstName == "日期") ? null : e;
            });

            var grphDates = new Array();
            var groupedObjects = new Array();
            $.each(table, function (ix, obj) {
                var existingObj;
                if ($.inArray(obj.項目, grphDates) >= 0) {
                    // Get index of existing object width date == obj.Date
                    var index = groupedObjects.map(function (o, i) {
                        if (o.項目 == obj.項目) return i;
                    }).filter(isFinite);

                    groupedObjects[index].金額 = (parseInt(groupedObjects[index].金額 || 0) + parseInt(obj.金額)).toString();

                } else {
                    groupedObjects.push(obj);
                    grphDates.push(obj.項目);

                }


            });

            $.each(groupedObjects, function (ix, obj) {
                total = (parseInt(total) || 0) + (parseInt(obj.金額));
                var obj = { name: obj.項目, y: parseInt(obj.金額) };
                chartSeries.push(obj);
            })
            $('#totalShow').html('總計:' + total);


            $('#Costcontainer').highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: '綜合支出統計圖 '
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.y}</b>'
                },
                credits: {
                    enabled: false
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            enabled: true

                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: '$',
                    colorByPoint: true,
                    data: chartSeries
                }]
            });


            $('#TableResult').DataTable();
        };






    </script>


    <script type="text/javascript">
        $(function () {
            // 預設顯示第一個 Tab
            var _showTab = '0';
            $('.Rabgne_tab').each(function () {
                // 目前的頁籤區塊
                var $tab = $(this);

                var $defaultLi = $('ul.nav-tabs li', $tab).eq(_showTab).addClass('active');
                $($defaultLi.find('a').attr('href')).siblings().hide();

                // 當 li 頁籤被點擊時...
                // 若要改成滑鼠移到 li 頁籤就切換時, 把 click 改成 mouseover
                $('ul.nav-tabs li', $tab).click(function () {



                    // 找出 li 中的超連結 href(#id)
                    var $this = $(this),
                        _clickTab = $this.find('a').attr('href');


                    // 把目前點擊到的 li 頁籤加上 .active
                    // 並把兄弟元素中有 .active 的都移除 class
                    $this.addClass('active').siblings('.active').removeClass('active');
                    // 淡入相對應的內容並隱藏兄弟元素
                    $(_clickTab).stop(false, true).fadeIn().siblings().hide();
                    $(window).resize();//重製大小

                    return false;

                }).find('a').focus(function () {
                    this.blur();
                });

            });

        });



    </script>



</head>

<body>
    <main role="main">


        <div class="container">

            <hr />
            <div class="Rabgne_tab">

                <ul class="nav nav-tabs">
                    <li><a href="#Rtab1">支出明細</a></li>
                    <li><a href="#Rtab2">支出統計圖</a></li>

                </ul>

                <div class="tab_container" style="border-style: double; border-color: #c5d0dc;">


                    <div id="Rtab2" class="tab_content">
                        <div id="Costcontainer" style="height: 600px; margin: 0 auto; padding-top: 80px;"></div>


                    </div>


                    <div id="Rtab1" class="tab_content">
                        <div class="row" style="padding: 20px;">
                            <div class="col-xs-12 col-sm-12 col-md-12">

                                <div style="text-align: right; font-size: 20px; font-weight: bold;">
                                    <div id="totalShow"></div>
                                </div>
                                <hr />
                                <div id="tableList"></div>

                                <hr />


                            </div>



                        </div>

                    </div>
                </div>



            </div>




            <hr />

        </div> <!-- /container -->

    </main>





</body>
</html>