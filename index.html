<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head runat="server">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta charset="UTF-8">

    <!-- TODO add manifest here -->
    <link rel="manifest" href="manifest.json">
    <!-- Add to home screen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="饅頭記帳">
    <link rel="apple-touch-icon" href="images/icon-128x128.png">
    <meta name="msapplication-TileImage" content="images/icon-128x128.png">
    <meta name="msapplication-TileColor" content="#2F3BA2">


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
    <link href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css"
        rel="stylesheet">
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-1.12.4.js" crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>




    <script>
        /*! tabletojson */
        !function (a) { "use strict"; a.fn.tableToJSON = function (b) { var c = { ignoreColumns: [], onlyColumns: null, ignoreHiddenRows: !0, ignoreEmptyRows: !1, headings: null, allowHTML: !1, includeRowId: !1, textDataOverride: "data-override", textExtractor: null }; b = a.extend(c, b); var d = function (a) { return void 0 !== a && null !== a }, e = function (c) { return d(b.onlyColumns) ? -1 === a.inArray(c, b.onlyColumns) : -1 !== a.inArray(c, b.ignoreColumns) }, f = function (b, c) { var e = {}, f = 0; return a.each(c, function (a, c) { f < b.length && d(c) && (e[b[f]] = c, f++) }), e }, g = function (c, d, e) { var f = a(d), g = b.textExtractor, h = f.attr(b.textDataOverride); return null === g || e ? a.trim(h || (b.allowHTML ? f.html() : d.textContent || f.text()) || "") : a.isFunction(g) ? a.trim(h || g(c, f)) : "object" == typeof g && a.isFunction(g[c]) ? a.trim(h || g[c](c, f)) : a.trim(h || (b.allowHTML ? f.html() : d.textContent || f.text()) || "") }, h = function (c, d) { var e = [], f = b.includeRowId, h = "boolean" == typeof f ? f : "string" == typeof f ? !0 : !1, i = "string" == typeof f == !0 ? f : "rowId"; return h && "undefined" == typeof a(c).attr("id") && e.push(i), a(c).children("td,th").each(function (a, b) { e.push(g(a, b, d)) }), e }, i = function (a) { var c = a.find("tr:first").first(); return d(b.headings) ? b.headings : h(c, !0) }, j = function (c, h) { var i, j, k, l, m, n, o, p = [], q = 0, r = []; return c.children("tbody,*").children("tr").each(function (c, e) { if (c > 0 || d(b.headings)) { var f = b.includeRowId, h = "boolean" == typeof f ? f : "string" == typeof f ? !0 : !1; n = a(e); var r = n.find("td").length === n.find("td:empty").length ? !0 : !1; !n.is(":visible") && b.ignoreHiddenRows || r && b.ignoreEmptyRows || n.data("ignore") && "false" !== n.data("ignore") || (q = 0, p[c] || (p[c] = []), h && (q += 1, "undefined" != typeof n.attr("id") ? p[c].push(n.attr("id")) : p[c].push("")), n.children().each(function () { for (o = a(this); p[c][q];)q++; if (o.filter("[rowspan]").length) for (k = parseInt(o.attr("rowspan"), 10) - 1, m = g(q, o), i = 1; k >= i; i++)p[c + i] || (p[c + i] = []), p[c + i][q] = m; if (o.filter("[colspan]").length) for (k = parseInt(o.attr("colspan"), 10) - 1, m = g(q, o), i = 1; k >= i; i++)if (o.filter("[rowspan]").length) for (l = parseInt(o.attr("rowspan"), 10), j = 0; l > j; j++)p[c + j][q + i] = m; else p[c][q + i] = m; m = p[c][q] || g(q, o), d(m) && (p[c][q] = m), q++ })) } }), a.each(p, function (c, g) { if (d(g)) { var i = d(b.onlyColumns) || b.ignoreColumns.length ? a.grep(g, function (a, b) { return !e(b) }) : g, j = d(b.headings) ? h : a.grep(h, function (a, b) { return !e(b) }); m = f(j, i), r[r.length] = m } }), r }, k = i(this); return j(this, k) } }(jQuery);

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.4/highcharts.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
    <script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>
    <script src="js/cookie.js"></script>

    <script>



        //init Date
        $(function () {

            //check setting
            if (getCookie('sheetkey') == null || getCookie('secret')==null || getCookie('username')==null || getCookie('sheetkey') == '' || getCookie('secret')=='' || getCookie('username')=='') {
                $('#keyModalCenter').modal({
    backdrop : "static",
    keyboard: false
});
                $('#modal-sheetkey').val(  getCookie('sheetkey'))
                $('#modal-secret').val(  getCookie('secret'))
                $('#modal-name').val(  getCookie('username'))
            }



            $("#SDT").datetimepicker({
                format: 'YYYY-MM-DD',
                defaultDate: new Date()
            }).on('dp.change', function (e) {
                initObject();
            });

            $("#EDT").datetimepicker({
                format: 'YYYY-MM-DD',
                defaultDate: new Date()
            }).on('dp.change', function (e) {
                initObject();
            });

            $("#modal-date").datetimepicker({
                format: 'YYYY-MM-DD HH:mm',
                defaultDate: new Date()
            }).on('dp.change', function (e) {
                initObject();
            });

        });


        function getParameterByName(name, url) {
            if (!url)

                return
        }

        var googleURL = '';

        function makeHttpObject() {
            $('#tab1').click();
            try {
                var url = window.location.href;
                var key = getCookie('sheetkey');
                var sql = "select A,B,C,D where  A >=date'" + $('#SDT').val() + "' AND A<=date'" + moment($('#EDT').val()).add(1, 'd').format('YYYY-MM-DD') + "'";
                googleURL = decodeURIComponent("https://docs.google.com/spreadsheets/d/" + key + "/gviz/tq?tqx=out:html&gid=0&tq=" + sql);
                console.log(googleURL)
                return new XMLHttpRequest();

            }
            catch (error) { }
            try { return new ActiveXObject("Msxml2.XMLHTTP"); }
            catch (error) { }
            try { return new ActiveXObject("Microsoft.XMLHTTP"); }
            catch (error) { }

            throw new Error("Could not create HTTP request object.");
        }

        function initObject() {
            var request = makeHttpObject();
            request.open("GET", googleURL, true);
            request.send(null);

            var tableHTML = '';
            var table = '';
            var chartSeries = [];
            var total;

            request.onreadystatechange = function () {
                if (request.readyState == 4)

                    tableHTML = (request.responseText).substring(request.responseText.indexOf("<table"), request.responseText.indexOf("</table")) + "</table>";
                var thead = tableHTML.substring(tableHTML.indexOf("<tr"), tableHTML.indexOf("</tr")) + "</tr>";
                tableHTML = tableHTML.replace(thead, "");
                tableHTML = tableHTML.replace(" cellspacing=\"0\">", " cellspacing='0'><thead>" + thead + "</thead>");


                $('#tableList').html(tableHTML.replace("<table", "<table id='TableResult' class='table table- striped' width='100%' "));




                var $table = $('#TableResult');

                table = $table.tableToJSON();
                var newTable = $.map(table, function (e) {
                    return (e.FirstName == "日期") ? null : e;
                });

                var grphDates = new Array();
                var groupedObjects = new Array();
                $.each(table, function (ix, obj) {
                    var existingObj;
                    if ($.inArray(obj.項目, grphDates) >= 0) {
                        // Get index of existing object width date == obj.Date
                        var index = groupedObjects.map(function (o, i) {
                            if (o.項目 == obj.項目) return i;
                        }).filter(isFinite);

                        groupedObjects[index].金額 = (parseInt(groupedObjects[index].金額 || 0) + parseInt(obj.金額)).toString();

                    } else {
                        groupedObjects.push(obj);
                        grphDates.push(obj.項目);

                    }


                });

                $.each(groupedObjects, function (ix, obj) {
                    total = (parseInt(total) || 0) + (parseInt(obj.金額));
                    var obj = { name: obj.項目, y: parseInt(obj.金額) };
                    chartSeries.push(obj);
                })
                $('#totalShow').html('總計:' + total);


                $('#Costcontainer').highcharts({
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false,
                        type: 'pie'
                    },
                    title: {
                        text: '綜合支出統計圖 '
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.y}</b>'
                    },
                    credits: {
                        enabled: false
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                                enabled: true

                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: '$',
                        colorByPoint: true,
                        data: chartSeries
                    }]
                });


                $('#TableResult').DataTable();
            };
        }







        $(function () {
            initObject();
        });
    </script>


    <script type="text/javascript">
        $(function () {
            // 預設顯示第一個 Tab
            var _showTab = '0';
            $('.Rabgne_tab').each(function () {
                // 目前的頁籤區塊
                var $tab = $(this);

                var $defaultLi = $('ul.nav-tabs li', $tab).eq(_showTab).addClass('active');
                $($defaultLi.find('a').attr('href')).siblings().hide();

                // 當 li 頁籤被點擊時...
                // 若要改成滑鼠移到 li 頁籤就切換時, 把 click 改成 mouseover
                $('ul.nav-tabs li', $tab).click(function () {



                    // 找出 li 中的超連結 href(#id)
                    var $this = $(this),
                        _clickTab = $this.find('a').attr('href');


                    // 把目前點擊到的 li 頁籤加上 .active
                    // 並把兄弟元素中有 .active 的都移除 class
                    $this.addClass('active').siblings('.active').removeClass('active');
                    // 淡入相對應的內容並隱藏兄弟元素
                    $(_clickTab).stop(false, true).fadeIn().siblings().hide();
                    $(window).resize();//重製大小

                    return false;

                }).find('a').focus(function () {
                    this.blur();
                });

            });

        });



    </script>



</head>

<body>
    <main role="main">


        <div class="container">
            <div class="page-header">
                <h1>支出紀錄</h1>

            </div>
            <button type="button" class="btn-lg btn-danger" style="position:fixed;bottom: 15px;right: 15px;z-index: 99; border-radius: 25px;"
                data-toggle="modal" data-target="#exampleModalCenter">
                +
            </button>

            <div class="row">

                <div class='col-xs-12'>
                    <div class="form-group">
                        日期：
                        <div class="btn-group" role="group" style="float: right;padding-bottom: 10px;">
                            <button type="button" class="btn btn-info" onclick="$('#SDT').val(moment().format('YYYY-MM-DD'));$('#EDT').val(moment().format('YYYY-MM-DD'));initObject();">今天</button>
                            <button type="button" class="btn btn-primary" onclick="$('#SDT').val(moment().format('YYYY-MM')+'-01');$('#EDT').val(moment().add(1,'M').format('YYYY-MM')+'-01');initObject()">本月</button>
                            <button type="button" class="btn btn-success" onclick="$('#SDT').val(moment().add(-1,'M').format('YYYY-MM')+'-01');$('#EDT').val(moment().format('YYYY-MM')+'-01');initObject()">上月</button>
                        </div>
                    </div>
                </div>

                <div class='col-xs-6'>
                    <div class="form-group">
                        <div class='input-group date'>
                            <input type='text' class="form-control" id='SDT' />
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>

                        </div>
                    </div>
                </div>

                <div class='col-xs-6'>

                    <div class="form-group">
                        <div class='input-group date'>
                            <input type='text' class="form-control" id='EDT' />
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>



            </div>

            <div class="Rabgne_tab">

                <ul class="nav nav-tabs">
                    <li>
                        <a id='tab1' href="#Rtab1">支出明細</a>
                    </li>
                    <li>
                        <a href="#Rtab2">支出統計圖</a>
                    </li>
                    <li>
                        <a href="#Rtab3">上月比較</a>
                    </li>

                </ul>

                <div class="tab_container" style="border-style: double; border-color: #c5d0dc;">


                    <div id="Rtab2" class="tab_content">
                        <div id="Costcontainer" style="height: 600px; margin: 0 auto; padding-top: 80px;"></div>


                    </div>


                    <div id="Rtab1" class="tab_content">
                        <div class="row" style="padding: 20px;">
                            <div class="col-xs-12 col-sm-12 col-md-12">

                                <div style="text-align: right; font-size: 20px; font-weight: bold;">
                                    <div id="totalShow"></div>
                                </div>
                                <hr />
                                <div id="tableList"></div>

                                <hr />


                            </div>



                        </div>

                    </div>


                    <div id="Rtab3" class="tab_content">
                        <div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>



                        <script>

                            Highcharts.chart('container', {
                                chart: {
                                    type: 'area'
                                },
                                title: {
                                    text: 'Historic and Estimated Worldwide Population Growth by Region'
                                },
                                subtitle: {
                                    text: 'Source: Wikipedia.org'
                                },
                                xAxis: {
                                    categories: ['1750', '1800', '1850', '1900', '1950', '1999', '2050'],
                                    tickmarkPlacement: 'on',
                                    title: {
                                        enabled: false
                                    }
                                },
                                yAxis: {
                                    title: {
                                        text: 'Billions'
                                    },
                                    labels: {
                                        formatter: function () {
                                            return this.value / 1000;
                                        }
                                    }
                                },
                                tooltip: {
                                    split: true,
                                    valueSuffix: ' millions'
                                },
                                plotOptions: {
                                    area: {
                                        stacking: 'normal',
                                        lineColor: '#666666',
                                        lineWidth: 1,
                                        marker: {
                                            lineWidth: 1,
                                            lineColor: '#666666'
                                        }
                                    }
                                },
                                series: [{
                                    name: 'Asia',
                                    data: [502, 635, 809, 947, 1402, 3634, 5268]
                                }, {
                                    name: 'Africa',
                                    data: [106, 107, 111, 133, 221, 767, 1766]
                                }, {
                                    name: 'Europe',
                                    data: [163, 203, 276, 408, 547, 729, 628]
                                }, {
                                    name: 'America',
                                    data: [18, 31, 54, 156, 339, 818, 1201]
                                }, {
                                    name: 'Oceania',
                                    data: [2, 2, 2, 6, 13, 30, 46]
                                }]
                            });</script>

                    </div>
                </div>



            </div>

            <!-- Modal -->
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">新增支出</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">日期:</label>

                                <input type='text' class="form-control" id='modal-date' />

                            </div>
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">項目:</label>
                                <input type="text" class="form-control" id="modal-item">
                            </div>
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">金額:</label>

                                <form name="calculator">

                                    <input type="text" class="form-control" name="display" style="font-size: 24px;
                                    font-weight: bold;
                                    color: red;" id="display" disabled>
                                    <div class="row">
                                        <div class='col-xs-12'>
                                            <div class="btn-group" role="group" style="width: 100%;" aria-label="calc1">
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="1" onclick="calculator.display.value += '1'">1</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="2" onclick="calculator.display.value += '2'">2</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="3" onclick="calculator.display.value += '3'">3</button>
                                                <button type="button" class="btn btn-lg  btn-primary  btn-calc" value="+" onclick="calculator.display.value += '+'">+</button>

                                            </div>
                                        </div>
                                        <div class='col-xs-12'>
                                            <div class="btn-group" role="group" style="width: 100%;" aria-label="calc1">
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="4" onclick="calculator.display.value += '4'">4</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="5" onclick="calculator.display.value += '5'">5</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="6" onclick="calculator.display.value += '6'">6</button>
                                                <button type="button" class="btn btn-lg  btn-primary  btn-calc" value="-" onclick="calculator.display.value += '-'">-</button>

                                            </div>
                                        </div>
                                        <div class='col-xs-12'>
                                            <div class="btn-group" role="group" style="width: 100%;" aria-label="calc1">
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="7" onclick="calculator.display.value += '7'">7</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="8" onclick="calculator.display.value += '8'">8</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="9" onclick="calculator.display.value += '9'">9</button>
                                                <button type="button" class="btn btn-lg  btn-primary  btn-calc" value="x" onclick="calculator.display.value += '*'">x</button>

                                            </div>
                                        </div>
                                        <div class='col-xs-12'>
                                            <div class="btn-group" role="group" style="width: 100%;" aria-label="calc1">
                                                <button type="button" id="clear" name="clear" class="btn btn-lg  btn-info  btn-calc" value="c" onclick="calculator.display.value = ''">c</button>
                                                <button type="button" class="btn btn-lg  btn-default btn-calc" value="0" onclick="calculator.display.value += '0'">0</button>
                                                <button type="button" class="btn btn-lg  btn-info  btn-calc" name="doit" value="=" onclick="calculator.display.value = eval(calculator.display.value)">=</button>
                                                <button type="button" class="btn btn-lg  btn-primary  btn-calc" name="div" value="/" onclick="calculator.display.value += '/'">/</button>

                                            </div>
                                        </div>

                                    </div>



                                </form>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" onclick="submitCalc()" class="btn btn-primary">送出</button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Modal -->
            <div class="modal fade" id="keyModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">第一次設定</h5>

                        </div>

                        <div class="modal-body">
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">Sheet Key:</label>

                                <input type='text' class="form-control" id='modal-sheetkey' />

                            </div>
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">Add secret:</label>
                                <input type="text" class="form-control" id="modal-secret">
                            </div>
                            <div class="form-group">
                                <label for="recipient-name" class="col-form-label">使用者名稱:</label>
                                <input type="text" class="form-control" id="modal-name">
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="saveSetting()" class="btn btn-primary">儲存</button>
                        </div>
                    </div>
                </div>
            </div>
            <hr />

        </div>
        <!-- /container -->

    </main>


    <div class="ui segment" id="loading" style="position: fixed;
    height: 100%;
    width: 100%;
    top: 0px;
    z-index: 99;
    display:none;
    background: white;
    opacity: 0.8;">
        <div style="position:relative;top:30%;">
            <img src="images/Loading_icon.gif" style="width: 100%">
        </div>
        <p></p>
        <p></p>
    </div>

    <script>

        function saveSetting() {//第一次設定
            setCookie('sheetkey', $('#modal-sheetkey').val(), 40000);
            setCookie('secret', $('#modal-secret').val(), 40000);
            setCookie('username', $('#modal-name').val(), 40000);

             $('#keyModalCenter').modal('hide');
             initObject();
        }

        function submitCalc() {
            $('#loading').css("display", "block");
            var name = getCookie('username');;
            var dt = $('#modal-date').val();
            var item = $('#modal-item').val();
            var price = eval($('#display').val());
            addTosheet(name, dt, item, price);
        }

        //add to google sheet
        let addTosheet = (name, date, item, price) => {

            var addsecret = getCookie('secret');;

            $.ajax({
                type: "post",
                data: {
                    "method": "write",
                    "name": name,
                    "date": date + ':00',
                    "item": item,
                    "price": price
                },
                url: 'https://script.google.com/macros/s/' + addsecret + '/exec'// 填入網路應用程式網址
            }).done(function () {

                console.log('OK');
                $('#exampleModalCenter').modal('hide')
                initObject();
                $('#loading').css("display", "none");
            });


        }
    </script>


    <style>
        .btn-calc {
            width: 25%;
        }
    </style>



    <!-- Uncomment the line below when ready to test with fake data -->
    <script src="scripts/app.js" async></script>
</body>

</html>